# 브라우저 렌더링 과정
📕notion : https://www.notion.so/fun-blog/38-83c7908859094fc39c5e43c57a5fc16700<br>

### 브라우저의  HTML요청과 서버의 응답

브라우저는 HTML, CSS, JavaScript, Image, font-file등 렌더링에 필요한 리소스를 요청하고 서버로부터 응답받는다.

- 브라우저는 사용자의 입력을 받아 서버로 URL과 함께 요청을 보낸다. DNS를 통해 IP주소로 변경되고, 해당 IP주소를 가진 서버로 요청이 전송된다. 이후 브라우저는 서버로부터 데이터를 응답받는다.
- 브라우저가 요청한 HTML안에 img, js script 태그들을 만나면 HTML파싱을 중단하고, 해당 리소스 파일을 서버로 요청한다. 브라우저는 서버로부터 해당 리소스 파일 데이터를 받고,  다시 HTML파싱을 이어간다.

### HTML파싱과 DOM생성, CSS파싱과 CSSOM생성, JS파싱과 AST생성

서버로부터 응답된 HTML, CSS, js문서는 문자열로 이루어져 있기 때문에 이를 브라우저가 이해할 수 있게 변환(파싱)한 자료 구조인 DOM과 CSSOM을 생성해 렌더트리를 구성한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/7c6e9f0f-1aff-4312-9eab-b24334836852/Untitled.png)

### HTML파싱과 DOM생성

서버는 브라우저가 요청한 HTML파일을 2진수 바이트 형식으로 응답한다. 
브라우저는 서버의 HTML데이터를 meta태그의 charset어트리뷰트의 인코딩방식( UTF-8 )에 의해 **문자열로 변환하고, 문법적 의미를 갖는 최소단위인 토큰으로 분해한다. 각 토큰들을 객체로 변환한 뒤, 노드를 생성하여 DOM을 구성한다.** 

### CSS파싱과 CSSOM생성

브라우저 렌더링 엔진은 HTML을 파싱하여 DOM을 구성하면서 CSS를 로드하는 link태그나 style태그를 만나면 **DOM생성을 중지하고 CSS파일의 파싱과정을 거쳐 CSSOM을 생성한다**. CSSOM생성이 끝나면 HTML 파싱을 이어가며 DOM생성을 재개한다. 

### JavaScript파싱과 AST생성

렌더링 엔진은 HTML을 파싱하다 JavaScript파일을 로드하는 script태그를 만나면 DOM생성을 중지하고, src파일을 서버에 요청한다. 

이후 **자바스크립트 엔진에 제어권을 넘겨 자바스크립트를 해석하여 추상적 구문 트리 ( AST )를 생성한다 AST를 기반으로 인터프리터가 실행할 수 있는 바이트코드로 변환하여 실행한다.** 자바스크립트 실행이 끝나면 다시 렌더링 엔진으로 제어권이 넘어와 DOM생성을 재개한다.

### 렌더트리 생성

브라우저 렌더링 엔진은 서버로부터 응답된 HTML과 CSS를 파싱하여 DOM과 CSSOM을 생성한다. 그리고 DOM과 CSSOM은 렌더링을 위해 렌더트리로 결합된다. 이때 브라우저 화면에 렌더링 되지 않는 노드와 CSS의  display:none과 같은 노드들은 포함하지 않는다. 

완성된 렌더트리는 HTML요소의 레이아웃을 계산하고, 브라우저 화면에 픽셀을 계산하는 페인팅 과정을 거치게 된다. 이와 같은 브라우저의 렌더링 과정은 반복 실행될 수 있다. 레이아웃 계산과 페인팅 과정이 반복 실행되는 경우에는 성능에 악영향을 줄 수 있으므로 CSS를 작성할 때에도 한번 신경쓰는 것이 좋다.

### 레이아웃 과정, 페인트(=렌더트리 그리기 )

렌더트리가 생성되면 레이아웃 과정을 거쳐 화면에 노드를 배치한다. 이후 렌더트리의 노드를 화면의 실제 픽셀로 변환해주는 페인트 과정을 거쳐 사용자의 브라우저 화면에 보여준다.

### 리플로우, 리페인트

자바스크립트 코드에 DOM이나 CSSOM을 변경하는 코드가 있으면 다시 DOM을 생성하고 새로운 렌더트리를 구성한다. 이를 기반으로 레이아웃과 페인트 과정을 거쳐 브라우저 화면에 렌더링 되는데 이를 리플로우, 리페인트라고 한다.

- 리플로우는 레이아웃 계산을 다시 하는 것을 말하며, 노드 추가/삭제, 요소 크기/위치 변경, 윈도우 리사이징 등 레이아웃에 영향을 주는 변경이 발생하는 경우에 실행된다.
- 리페인트는 재결합된 렌더 트리를 기반으로 브라우저 화면에 픽셀을 계산하는 것을 말한다.

### 렌더링이 반복되는 경우

브라우저 렌더링 과정은 반복해서 실행될 수 있다. 레이아웃 계산과 페인팅을 다시 실행하는 리렌더링은 성능에 악영향을 줄 수 있으므로 가급적 빈번하게 리렌더링이 발생하는 일이 없도록 코딩을 하는 것이 좋다. 

- 자바스크립트에 의해 노드가 추가/삭제되는 경우
- 브라우저 창의 리사이징에 의해 뷰포트의 크기가 변경되는 경우
- HTML의 레이아웃등의 변경이 일어나는 경우
( width, height, padding, margin, border, display, position, top, right, left, bottom… )
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f62ba130-5aa7-4c09-a5af-0257182b99d2/Untitled.png)
    

---

### script태그의 위치가 중요한 의미를 갖는 이유?

브라우저는 동기적으로 HTML, CSS, JavaScript를 파싱하고 실행한다. 이것은 script태그의 위치에 따라  HTML파싱이 블로킹되어 DOM생성이 지연될 수 있다는 것을 의미한다. 아래의 사진에서 script태그가 파싱되고 실행되는데, 아직 HTML태그들이 읽히지 않아 DOM이 생성되지 않은 경우. 자바스크립트 파일에서 해당 node가 파싱되지 않아 문제가 발생할 수 있다.

- DOM이 완성되지 않은 상태에서 DOM을 조작하면 에러가 발생할 수 있다
- 자바스크립트 로딩/파싱/실행으로 인해 HTML요소의 렌더링에 로딩 시간이 길어질 수 있다.

이러한 문제를 회피하기 위해 body요소 가장 아래에 자바스크립트를 위치시키는 게 좋다. 

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/86ad1991-8634-4ffd-bb55-5be8929c4135/Untitled.png)

### script태그의 async / defer 어트리뷰트

자바스크립트 파싱에 의한 DOM생성이 중단되는 문제를 해결하기 위해 script태그에 async와 defer 어트리뷰트가 추가되었다. 이들은 외부 자바스크립트 파일을 로드하는 경우에만 사용할 수 있다. src 어트리뷰트가 없는 인라인 자바스크립트에는 사용할 수 없다. 

async와 defer어트리뷰트를 사용하면 HTML파싱과 외부 자바스크립트 파일의 로드가 비동기적으로 동시에 진행된다. 이 둘의 차이점은 자바스크립트의 실행 시점에 차이가 있다.

```jsx
<script async src='app.js'></script>
<script defer src='app.js'></script>
```

- async 어트리뷰트
    
    HTML파싱과 자바스크립트 파일의 로드가 동시에 진행된다. 자바스크립트 파일의 로드가 완료된 직후에 실행이되며, 이때 HTML파싱이 중단된다. 
    
    여러개의 script태그에 async어트리뷰트를 지정하면 script태그의 순서와는 상관없이 로드가 완료된 스크립트먼저 실행되므로 자바스크립트의 실행 순서가 보장되지 않는다. 따라서 순서의 보장이 필요한 script에는 async를 사용하지 않아야 한다.
    
- defer 어트리뷰트
    
    HTML파싱과 자바스크립트 파일의 로드가 동시에 진행되지만, defer는 HTML파싱이 완료되어 DOM생성이 끝난 후에 자바스크립트가 동작한다. 
    ( = DOM생성 직후 DOMContentLoaded이벤트가 실행되어 JS가 실행 )
    
    ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6e484b7c-74ec-4310-88b0-3188d5ea8170/Untitled.png)